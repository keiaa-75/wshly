<div th:fragment="custom-dropdown(name, options, selectedValue)" xmlns:th="http://www.thymeleaf.org">
<style>
.pixel-dropdown {
    position: relative;
    width: 100%;
}

.pixel-dropdown-button {
    width: 100%;
    background: white;
    border: 3px solid #000;
    padding: 8px 12px;
    color: #374151;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    clip-path: polygon(
        0 4px, 2px 4px, 2px 2px, 4px 2px, 4px 0,
        calc(100% - 4px) 0, calc(100% - 4px) 2px, calc(100% - 2px) 2px, calc(100% - 2px) 4px, 100% 4px,
        100% calc(100% - 4px), calc(100% - 2px) calc(100% - 4px), calc(100% - 2px) calc(100% - 2px), calc(100% - 4px) calc(100% - 2px), calc(100% - 4px) 100%,
        4px 100%, 4px calc(100% - 2px), 2px calc(100% - 2px), 2px calc(100% - 4px), 0 calc(100% - 4px)
    );
    transition: all 0.1s ease;
    box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8), inset -1px -1px 0 rgba(0,0,0,0.2);
}

.pixel-dropdown-button:hover {
    background: var(--theme-50);
    box-shadow: inset 1px 1px 0 rgba(255,255,255,0.9), inset -1px -1px 0 rgba(0,0,0,0.1);
}

.pixel-dropdown-button.open {
    background: var(--theme-100);
    box-shadow: inset -1px -1px 0 rgba(255,255,255,0.5), inset 1px 1px 0 rgba(0,0,0,0.3);
}

.pixel-dropdown-button:focus {
    background: var(--theme-50);
    border-color: var(--theme-400);
}

.pixel-dropdown-arrow {
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 6px solid #374151;
    transition: transform 0.2s ease;
}

.pixel-dropdown-button.open .pixel-dropdown-arrow {
    transform: rotate(180deg);
}

.pixel-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 3px solid #000;
    margin-top: 2px;
    z-index: 50;
    max-height: 200px;
    overflow-y: auto;
    clip-path: polygon(
        0 4px, 2px 4px, 2px 2px, 4px 2px, 4px 0,
        calc(100% - 4px) 0, calc(100% - 4px) 2px, calc(100% - 2px) 2px, calc(100% - 2px) 4px, 100% 4px,
        100% calc(100% - 4px), calc(100% - 2px) calc(100% - 4px), calc(100% - 2px) calc(100% - 2px), calc(100% - 4px) calc(100% - 2px), calc(100% - 4px) 100%,
        4px 100%, 4px calc(100% - 2px), 2px calc(100% - 2px), 2px calc(100% - 4px), 0 calc(100% - 4px)
    );
    box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(-4px);
    transition: all 0.15s ease;
    pointer-events: none;
}

.pixel-dropdown-menu.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
}

.pixel-dropdown-option {
    padding: 8px 12px;
    cursor: pointer;
    font-weight: bold;
    color: #374151;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.1s ease;
}

.pixel-dropdown-option:last-child {
    border-bottom: none;
}

.pixel-dropdown-option:hover {
    background: var(--theme-100);
    color: var(--theme-700);
}

.pixel-dropdown-option.selected {
    background: var(--theme-400);
    color: white;
}

.pixel-dropdown-option.focused {
    background: var(--theme-100);
    color: var(--theme-700);
}

.pixel-dropdown-option.selected.focused {
    background: var(--theme-500);
    color: white;
}
</style>

<div class="pixel-dropdown" th:data-name="${name}">
    <button type="button" class="pixel-dropdown-button font-superhelio" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="mainMessage-label">
        <span class="dropdown-text" th:text="${selectedValue != null ? selectedValue.displayText : 'Select message...'}">Select message...</span>
        <div class="pixel-dropdown-arrow" aria-hidden="true"></div>
    </button>
    
    <div class="pixel-dropdown-menu" role="listbox">
        <div th:each="option : ${options}" 
             class="pixel-dropdown-option font-superhelio"
             role="option"
             th:data-value="${option}"
             th:text="${option.displayText}"
             th:classappend="${selectedValue != null && selectedValue == option} ? 'selected' : ''"
             th:attr="aria-selected=${selectedValue != null && selectedValue == option}">
        </div>
    </div>
    
    <!-- Hidden input for form submission -->
    <input type="hidden" th:name="${name}" th:value="${selectedValue != null ? selectedValue : ''}">
</div>

<script>
$(document).ready(function() {
    const $dropdown = $('.pixel-dropdown[data-name="' + /*[[${name}]]*/ 'mainMessage' + '"]');
    if (!$dropdown.length) return;
    
    const $button = $dropdown.find('.pixel-dropdown-button');
    const $menu = $dropdown.find('.pixel-dropdown-menu');
    const $options = $dropdown.find('.pixel-dropdown-option');
    const $hiddenInput = $dropdown.find('input[type="hidden"]');
    const $dropdownText = $dropdown.find('.dropdown-text');
    
    // Toggle dropdown
    $button.on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isOpen = $button.hasClass('open');
        
        // Close all other dropdowns
        $('.pixel-dropdown-button.open').not($button).removeClass('open')
            .attr('aria-expanded', 'false')
            .siblings('.pixel-dropdown-menu').removeClass('open');
        
        $button.toggleClass('open', !isOpen).attr('aria-expanded', !isOpen);
        $menu.toggleClass('open', !isOpen);
    });
    
    // Handle option selection
    $options.on('click', function() {
        const value = $(this).data('value');
        const text = $(this).text();
        
        $options.removeClass('selected').attr('aria-selected', 'false');
        $(this).addClass('selected').attr('aria-selected', 'true');
        
        $dropdownText.text(text);
        $hiddenInput.val(value).trigger('change');
        
        $button.removeClass('open').attr('aria-expanded', 'false');
        $menu.removeClass('open');
    });
    
    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$dropdown.is(e.target) && !$dropdown.has(e.target).length) {
            $button.removeClass('open').attr('aria-expanded', 'false');
            $menu.removeClass('open');
        }
    });
    
    // Keyboard navigation
    let focusedIndex = -1;
    
    function setFocusedOption(index) {
        $options.removeClass('focused');
        focusedIndex = Math.max(0, Math.min(index, $options.length - 1));
        const $focused = $options.eq(focusedIndex).addClass('focused');
        $focused[0].scrollIntoView({ block: 'nearest' });
    }
    
    $button.on('keydown', function(e) {
        const isOpen = $button.hasClass('open');
        
        if ((e.key === 'Enter' || e.key === ' ') && isOpen && focusedIndex >= 0) {
            e.preventDefault();
            $options.eq(focusedIndex).trigger('click');
        } else if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
            e.preventDefault();
            if (!isOpen) {
                $button.addClass('open').attr('aria-expanded', 'true');
                $menu.addClass('open');
                focusedIndex = $options.index($options.filter('.selected'));
                setFocusedOption(focusedIndex >= 0 ? focusedIndex : 0);
            } else if (e.key === 'ArrowDown') {
                setFocusedOption(focusedIndex + 1);
            }
        } else if (e.key === 'ArrowUp' && isOpen) {
            e.preventDefault();
            setFocusedOption(focusedIndex - 1);
        } else if (e.key === 'Escape' && isOpen) {
            $button.removeClass('open').attr('aria-expanded', 'false');
            $menu.removeClass('open');
            $options.removeClass('focused');
        }
    });
});
</script>
</div>
