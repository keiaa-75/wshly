<div>
<style>
.pixel-dropdown {
    position: relative;
    width: 100%;
}

.pixel-dropdown-button {
    width: 100%;
    background: white;
    border: 3px solid #000;
    padding: 8px 12px;
    color: #374151;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    clip-path: polygon(
        0 4px, 2px 4px, 2px 2px, 4px 2px, 4px 0,
        calc(100% - 4px) 0, calc(100% - 4px) 2px, calc(100% - 2px) 2px, calc(100% - 2px) 4px, 100% 4px,
        100% calc(100% - 4px), calc(100% - 2px) calc(100% - 4px), calc(100% - 2px) calc(100% - 2px), calc(100% - 4px) calc(100% - 2px), calc(100% - 4px) 100%,
        4px 100%, 4px calc(100% - 2px), 2px calc(100% - 2px), 2px calc(100% - 4px), 0 calc(100% - 4px)
    );
    transition: all 0.1s ease;
    box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8), inset -1px -1px 0 rgba(0,0,0,0.2);
}

.pixel-dropdown-button:hover {
    background: var(--theme-50);
    box-shadow: inset 1px 1px 0 rgba(255,255,255,0.9), inset -1px -1px 0 rgba(0,0,0,0.1);
}

.pixel-dropdown-button.open {
    background: var(--theme-100);
    box-shadow: inset -1px -1px 0 rgba(255,255,255,0.5), inset 1px 1px 0 rgba(0,0,0,0.3);
}

.pixel-dropdown-button:focus {
    background: var(--theme-50);
    border-color: var(--theme-400);
}

.pixel-dropdown-arrow {
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 6px solid #374151;
    transition: transform 0.2s ease;
}

.pixel-dropdown-button.open .pixel-dropdown-arrow {
    transform: rotate(180deg);
}

.pixel-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 3px solid #000;
    margin-top: 2px;
    z-index: 50;
    max-height: 200px;
    overflow-y: auto;
    clip-path: polygon(
        0 4px, 2px 4px, 2px 2px, 4px 2px, 4px 0,
        calc(100% - 4px) 0, calc(100% - 4px) 2px, calc(100% - 2px) 2px, calc(100% - 2px) 4px, 100% 4px,
        100% calc(100% - 4px), calc(100% - 2px) calc(100% - 4px), calc(100% - 2px) calc(100% - 2px), calc(100% - 4px) calc(100% - 2px), calc(100% - 4px) 100%,
        4px 100%, 4px calc(100% - 2px), 2px calc(100% - 2px), 2px calc(100% - 4px), 0 calc(100% - 4px)
    );
    box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(-4px);
    transition: all 0.15s ease;
    pointer-events: none;
}

.pixel-dropdown-menu.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
}

.pixel-dropdown-option {
    padding: 8px 12px;
    cursor: pointer;
    font-weight: bold;
    color: #374151;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.1s ease;
}

.pixel-dropdown-option:last-child {
    border-bottom: none;
}

.pixel-dropdown-option:hover {
    background: var(--theme-100);
    color: var(--theme-700);
}

.pixel-dropdown-option.selected {
    background: var(--theme-400);
    color: white;
}

.pixel-dropdown-option.focused {
    background: var(--theme-100);
    color: var(--theme-700);
}

.pixel-dropdown-option.selected.focused {
    background: var(--theme-500);
    color: white;
}
</style>

<div class="pixel-dropdown" data-name="mainMessage">
    <button type="button" class="pixel-dropdown-button font-superhelio" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="mainMessage-label">
        <span class="dropdown-text">Select message...</span>
        <div class="pixel-dropdown-arrow" aria-hidden="true"></div>
    </button>
    
    <div class="pixel-dropdown-menu pixel-dropdown-options" role="listbox">
        <!-- Options will be populated by script.js -->
    </div>
    
    <!-- Hidden input for form submission -->
    <input type="hidden" name="mainMessage" value="">
</div>

<script>
    // Make dropdowns interactive
    $('.pixel-dropdown').each(function() {
        const $dropdown = $(this);
        // Prevent re-initialization
        if ($dropdown.data('initialized')) {
            return;
        }
        $dropdown.data('initialized', true);

        const $button = $dropdown.find('.pixel-dropdown-button');
        const $menu = $dropdown.find('.pixel-dropdown-menu');
        const $hiddenInput = $dropdown.find('input[type="hidden"]');
        const $dropdownText = $dropdown.find('.dropdown-text');
        
        $button.on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = $button.hasClass('open');
            // Close all other dropdowns
            $('.pixel-dropdown-button.open').not($button).removeClass('open')
                .attr('aria-expanded', 'false')
                .siblings('.pixel-dropdown-menu').removeClass('open');
            $button.toggleClass('open', !isOpen).attr('aria-expanded', !isOpen);
            $menu.toggleClass('open', !isOpen);
        });
        
        // Use event delegation for options that might be added dynamically
        $menu.on('click', '.pixel-dropdown-option', function() {
            const value = $(this).data('value');
            const text = $(this).text();
            $menu.find('.pixel-dropdown-option').removeClass('selected').attr('aria-selected', 'false');
            $(this).addClass('selected').attr('aria-selected', 'true');
            $dropdownText.text(text);
            $hiddenInput.val(value).trigger('change');
            $button.removeClass('open').attr('aria-expanded', 'false');
            $menu.removeClass('open');
        });

        // Keyboard navigation
        let focusedIndex = -1;
        function setFocusedOption(index) {
            const $options = $menu.find('.pixel-dropdown-option');
            if (!$options.length) return;
            $options.removeClass('focused');
            focusedIndex = Math.max(0, Math.min(index, $options.length - 1));
            const $focused = $options.eq(focusedIndex).addClass('focused');
            $focused[0].scrollIntoView({ block: 'nearest' });
        }
        
        $dropdown.on('keydown', function(e) {
            const isOpen = $button.hasClass('open');
            const $options = $menu.find('.pixel-dropdown-option');

            if ((e.key === 'Enter' || e.key === ' ') && isOpen && focusedIndex >= 0) {
                e.preventDefault();
                $options.eq(focusedIndex).trigger('click');
            } else if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
                e.preventDefault();
                if (!isOpen) {
                    $button.trigger('click');
                    focusedIndex = $options.index($options.filter('.selected'));
                    setFocusedOption(focusedIndex >= 0 ? focusedIndex : 0);
                } else {
                    setFocusedOption(focusedIndex + 1);
                }
            } else if (e.key === 'ArrowUp' && isOpen) {
                e.preventDefault();
                setFocusedOption(focusedIndex - 1);
            } else if (e.key === 'Escape' && isOpen) {
                $button.trigger('click');
            }
        });
    });

    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        const $openDropdown = $('.pixel-dropdown-button.open');
        if ($openDropdown.length && !$openDropdown.closest('.pixel-dropdown').is(e.target) && $openDropdown.closest('.pixel-dropdown').has(e.target).length === 0) {
            $openDropdown.trigger('click');
        }
    });
</script>
</div>

